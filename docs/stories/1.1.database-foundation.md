# Story 1.1: Database Foundation & Enhanced Audit Trail

## Status
Draft

## Story

**As a** store owner,  
**I want** complete tracking of all pricing changes with detailed audit trails,  
**so that** I can maintain compliance, understand pricing history, and have confidence in pricing decisions.

## Acceptance Criteria

1. PostgreSQL database replaces SQLite for session storage and adds campaign/audit tables
2. Every pricing change (manual or automated) creates audit trail record with timestamp, old/new price, trigger reason
3. Pricing job results table includes audit trail references and export capabilities
4. Database migration preserves all existing session data without disruption
5. Enhanced results display shows job IDs, execution time, and detailed change tracking

## Integration Verification

- **IV1**: All existing admin.tsx pricing functionality works identically with PostgreSQL backend
- **IV2**: Session management and Shopify authentication remain completely functional
- **IV3**: Performance testing confirms no degradation with audit trail recording during high-volume changes

## Tasks / Subtasks

- [ ] **Task 1: PostgreSQL Database Migration** (AC: 1, 4)
  - [ ] Install and configure PostgreSQL database connection
  - [ ] Create Prisma schema for PostgreSQL with all required tables
  - [ ] Implement database migration script to transfer existing SQLite session data to PostgreSQL
  - [ ] Update database client configuration in `app/db.server.ts`
  - [ ] Test session functionality with PostgreSQL backend

- [ ] **Task 2: Campaign Management Tables** (AC: 1)
  - [ ] Create campaigns table with UUID primary keys and proper indexing
  - [ ] Create pricing_rules table with campaign relationships
  - [ ] Create shopify_shops table for multi-tenant support
  - [ ] Create webhook_logs table for reliability tracking
  - [ ] Add database triggers for automatic timestamp updates

- [ ] **Task 3: Audit Trail System** (AC: 2)
  - [ ] Create audit_trail_entries table with comprehensive change tracking
  - [ ] Implement AuditLogger service in `app/services/audit-logger.server.ts`
  - [ ] Create audit repository in `app/models/audit.server.ts`
  - [ ] Add audit trail indexes for performance optimization
  - [ ] Integrate audit logging into existing pricing operations

- [ ] **Task 4: Enhanced Pricing Job Tables** (AC: 3)
  - [ ] Create pricing_jobs table with improved structure
  - [ ] Create selected_variants table for job inputs
  - [ ] Create processing_results table with audit trail references
  - [ ] Implement PricingJobRepository in `app/models/pricing-job.server.ts`
  - [ ] Add export functionality for job results

- [ ] **Task 5: Integration with Existing System** (AC: 1, 4, 5)
  - [ ] Update existing admin.tsx pricing logic to use PostgreSQL
  - [ ] Preserve all existing GraphQL query patterns
  - [ ] Maintain existing Shopify authentication flow
  - [ ] Enhance results display with job IDs and execution tracking
  - [ ] Add performance monitoring for audit trail overhead

- [ ] **Task 6: Testing and Validation** (AC: All IVs)
  - [ ] Write unit tests for all repository classes
  - [ ] Write integration tests for database operations
  - [ ] Performance test audit trail recording during bulk operations
  - [ ] Validate session management continues working
  - [ ] Test complete pricing workflow end-to-end

## Dev Notes

### Previous Story Insights
No previous stories exist (this is story 1.1).

### Data Models
**Complete database schema defined** [Source: architecture/database-schema.md]:

- **audit_trail_entries**: Core table for compliance tracking with entity_type, entity_id, change_type, old_value, new_value, trigger_reason, timestamp, and metadata JSONB
- **campaigns**: Campaign management with UUID primary key, status enum, target_products array, trigger tracking
- **pricing_rules**: Conditional logic for both campaigns and manual jobs with when/then pattern
- **pricing_jobs**: Manual pricing operations with type enum, status tracking, bulk operation support
- **processing_results**: Individual variant results with audit trail references
- **sessions**: Migrated session storage maintaining existing functionality
- **webhook_logs**: Reliability tracking with payload storage and processing status

**Key TypeScript interfaces** [Source: architecture/data-models.md]:
```typescript
interface AuditTrailEntry {
  id: string;
  entityType: 'variant' | 'product';
  changeType: 'price_update' | 'compare_at_update' | 'inventory_sync';
  oldValue: string;
  newValue: string;
  triggerReason: string;
  timestamp: Date;
  metadata?: Record<string, any>;
}

interface ProcessingResult {
  id: string;
  variantId: string;
  success: boolean;
  auditTrailId?: string;
  // ... existing result fields
}
```

### API Specifications
**Database operations use repository pattern** [Source: architecture/backend-architecture.md]:

- **CampaignRepository**: CRUD operations in `app/models/campaign.server.ts`
- **AuditRepository**: Audit trail management in `app/models/audit.server.ts`  
- **PricingJobRepository**: Job management in `app/models/pricing-job.server.ts`

**Authentication preserved** [Source: architecture/backend-architecture.md]:
- Continue using `authenticate.admin(request)` from existing `app/shopify.server.ts`
- Session storage migrated but authentication flow unchanged

### File Locations
[Source: architecture/unified-project-structure.md]

**Database & Schema:**
- `prisma/schema.prisma` - Complete PostgreSQL schema definition
- `prisma/migrations/` - Database migration files
- `app/db.server.ts` - Database client (update for PostgreSQL)

**Data Access Layer:**
- `app/models/campaign.server.ts` - Campaign repository
- `app/models/audit.server.ts` - Audit trail repository  
- `app/models/pricing-job.server.ts` - Pricing job repository
- `app/models/session.server.ts` - Session management

**Services:**
- `app/services/audit-logger.server.ts` - Audit trail logging service

**Types:**
- `app/types/campaign.ts` - Campaign-related types
- `app/types/audit.ts` - Audit trail types
- `app/types/pricing-job.ts` - Pricing job types

### Technical Constraints
**Technology Stack** [Source: architecture/tech-stack.md]:
- **Database**: PostgreSQL 15+ (replacing SQLite)
- **ORM**: Prisma 6.2.1 (maintain existing version)
- **Backend Framework**: Remix 2.16.1 (preserve existing setup)
- **Authentication**: Shopify App Auth (no changes)

**Database Performance** [Source: architecture/database-schema.md]:
- UUID primary keys with proper indexing
- Audit trail partitioning consideration for 2+ years retention
- Critical indexes for campaign queries, audit trail lookups
- Batch processing limits (5 variants per batch) maintained

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- `tests/unit/models/` - Repository unit tests
- `tests/integration/database/` - Database integration tests
- `tests/integration/api/` - API endpoint tests

**Testing Frameworks:**
- **Unit Testing**: Vitest + mocking for repository classes
- **Integration Testing**: Vitest + Supertest for database operations
- **Database Setup**: Test database setup/cleanup utilities

**Specific Test Requirements:**
- Audit trail creation validation for every price change
- Session data migration integrity testing
- Performance testing for audit overhead during bulk operations
- Authentication flow preservation validation

## Testing

**Test Organization** [Source: architecture/testing-strategy.md]:
- Unit tests in `tests/unit/models/` for all repository classes
- Integration tests in `tests/integration/database/` for data operations
- Database migration tests to ensure session data preservation
- Performance tests for audit trail overhead measurement

**Testing Standards:**
- Use Vitest testing framework with TypeScript support
- Mock Shopify GraphQL responses in unit tests
- Test database setup/cleanup for integration tests
- Validate audit trail entries created for every price change

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here after implementation*